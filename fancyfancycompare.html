<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="robots" content="noindex, nofollow" />
    <title>BMI Task</title>
    <style type="text/css">
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e6f2ff;
            margin: 0;
            padding: 0;
        }

        .center {
            text-align: center;
        }

        body,
        td,
        th {
            color: #333;
        }

        larger {
            font-size: larger;
            text-align: right;
        }

        table {
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
        }

        fixed {
            font-family: Courier, monospace;
            white-space: pre;
            background-color: cornsilk;
        }

        .center {
            text-align: center;
        }

        .menu-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .highlight {
            background-color: #b3d1ff;
            opacity: 1.0
        }

        .tables-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .center {
            margin: 0 20px;
        }

        h1, h2, h3 {
            margin-bottom: 24px;
        }

        table, th, td {
            border: 1px solid #999;
            padding: 8px 16px;
        }

        th {
            background-color: #b3d1ff;
        }

        button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0069d9;
        }

        input[type="submit"] {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        input[type="submit"]:hover {
            background-color: #0069d9;
        }
        .chart-container {
            display: flex;
            flex-direction: column;
        }


    </style>
</head>

<body>
    <h3 class="center">COA123 - Web Programming</h3>
    <h2 class="center">Individual Coursework - Olympic Cyclists</h2>
    <h1 class="center">Task 4 - (compare.php)</h1>
    <br>
    <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="get" id="compare">
        <table border="1">
            <tr>
                <th scope="col">Key</th>
                <th scope="col">Value</th>
            </tr>
            <tr>
                <td><label for="country1">Country 1</label></td>
                <td><input name="country1" type="text" class="larger" id="country1" size="5" pattern="[A-Za-z]{3,3}"
                        required
                        value="<?php echo isset($_GET['country1']) ? htmlspecialchars($_GET['country1']) : ''; ?>" />
                </td>
            </tr>
            <tr>
                <td><label for="country2">Country 2</label></td>
                <td><input name="country2" type="text" class="larger" id="country2" size="5" pattern="[A-Za-z]{3,3}"
                        required
                        value="<?php echo isset($_GET['country2']) ? htmlspecialchars($_GET['country2']) : ''; ?>" />
                </td>
            </tr>
            <tr>
                <td><label for="submit">Submit</label></td>
                <td><input type="submit" id="submit" class="larger" /></td>
            </tr>
        </table>
    </form>
    <br>
    <div class="menu-container">
        <div class="center">
            <select id="sortMenu">
                <option value="sort">Sort</option>
                <option value="Total">Total Medals</option>
                <option value="gold">Gold Medals</option>
                <option value="sliver">Silver Medals</option>
                <option value="bronze">Bronze Medals</option>
                <option value="Num_Cyclists">NO. Cyclists</option>
            </select>
        </div>

        <div class="center">
            <button id="display">Display</button>
        </div>
    </div>

    <br>
    <?php
    // Process form data when the form is submitted
    if ($_SERVER['REQUEST_METHOD'] === 'GET') {
        if (isset($_GET['country1']) && isset($_GET['country2'])) {
            $country1 = $_GET['country1'];
            $country2 = $_GET['country2'];

            // Establish database connection (modify the parameters as needed)
            $servername = "sciâ€mysql";
            $username = "coa123cycle";
            $password = "bgt87awx!@2FD";
            $database = "coa123cdb";

            $conn = new mysqli($servername, $username, $password, $database);
            if ($conn->connect_error) {
                die("Connection failed: " . $conn->connect_error);
            }

            // Retrieve medal information and cyclists' names for Country 1
            $allCountriesQuery = "SELECT c.iso_id, c.total AS Total, c.gold AS Gold, c.silver AS Silver, c.bronze AS Bronze, Count(cy.iso_id) AS Num_Cyclists 
                                  FROM country c LEFT JOIN cyclist cy ON c.iso_id = cy.iso_id 
                                  GROUP BY c.iso_id 
                                  ORDER BY Total DESC";
            $allCountriesResult = $conn->query($allCountriesQuery);

            // Store the selected countries in an array
            $selectedCountries = [$country1, $country2];

            echo '<div class="tables-container chart-container">';
            // Display the comparison results
            echo '<table border= "1" class="center" id="resultsTable">';
            echo '<tr>';
            echo '<th>Rank</th>'; // Add this line
            echo '<th>Country</th>';
            echo '<th>Total Medals</th>';
            echo '<th>Gold</th>';
            echo '<th>Silver</th>';
            echo '<th>Bronze</th>';
            echo '<th>Num_Cyclists</th>';
            echo '</tr>';

            $rank = 1;
            while ($row = $allCountriesResult->fetch_assoc()) {
                $countryCode = $row['iso_id'];
                $isHighlighted = in_array($countryCode, $selectedCountries) ? 'highlight' : '';
                echo "<tr class='{$isHighlighted}' data-country='{$countryCode}'>";
                echo "<td>{$rank}</td>"; // Add this line
                echo "<td>{$countryCode}</td>";
                echo "<td>{$row['Total']}</td>";
                echo "<td>{$row['Gold']}</td>";
                echo "<td>{$row['Silver']}</td>";
                echo "<td>{$row['Bronze']}</td>";
                echo "<td>{$row['Num_Cyclists']}</td>";
                echo '</tr>';
                $rank++;
            }
            echo '</table>';
        
            // Retrieve cyclists' names for the selected countries
            $cyclistsQuery = "SELECT name, iso_id FROM cyclist WHERE iso_id IN ('$country1', '$country2')";
            $cyclistsResult = $conn->query($cyclistsQuery);

            // Store the cyclists' names in an associative array
            $cyclists = [];
            while ($row = $cyclistsResult->fetch_assoc()) {
                $cyclists[$row['iso_id']][] = $row['name'];
            }

            $populationGDPQuery = "SELECT iso_id, population, gdp FROM country WHERE iso_id IN ('$country1', '$country2')";
            $populationGDPResult = $conn->query($populationGDPQuery);
            
            // Store the population and GDP data in an associative array
            $populationGDPData = [];
            while ($row = $populationGDPResult->fetch_assoc()) {
                $populationGDPData[$row['iso_id']] = ['population' => $row['population'], 'gdp' => $row['gdp']];
            }
            echo '<script>;
                 const populationGDPData = ' . json_encode($populationGDPData) . ';
            </script>';
            

            echo '<table border="1" class="center" id="namesTable">';
            echo '<tr>';
            echo "<th>{$country1}</th>";
            echo "<th>{$country2}</th>";
            echo '</tr>';

            // Create a single row for the cyclists list
            echo '<tr>';

            // Add cyclists for country 1
            if (isset($cyclists[$country1])) {
                echo '<td>';
                foreach ($cyclists[$country1] as $cyclist) {
                    echo "- {$cyclist}<br>";
                }
                echo '</td>';
            } else {
                echo '<td>&nbsp;</td>';
            }

            // Add cyclists for country 2
            if (isset($cyclists[$country2])) {
                echo '<td>';
                foreach ($cyclists[$country2] as $cyclist) {
                    echo "- {$cyclist}<br>";
                }
                echo '</td>';
            } else {
                echo '<td>&nbsp;</td>';
            }
            echo '</tr>';
            echo '</table>';
            echo '</div>';
            
            // Close the database connection
            $conn->close();
            echo '</table>';
                
        }
    }
    

        
?>
    <br>
    <div class="chart-container">
        <canvas id="myChart" width="400" height="200" style="display: none;"></canvas>
    </div>      
    <br>
    <div class="center">
        <button id="resetBtn">Reset</button>
    </div>
    <script>
        // Get the "Reset" button element and the results table element
        const resetBtn = document.getElementById('resetBtn');
        const resultsTable = document.getElementById('resultsTable');

        // Add a click event listener to the "Reset" button
        resetBtn.addEventListener('click', () => {
            while (resultsTable.rows.length > 0) {
                resultsTable.deleteRow(0);
            }
            while (namesTable.rows.length > 0) {
                namesTable.deleteRow(0);
            }
        });
    </script>
    <script>
        const sortMenu = document.getElementById('sortMenu');

        sortMenu.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            const table = document.getElementById('resultsTable');
            const rows = Array.from(table.querySelectorAll('tr:not(:first-child)'));

            // Get the column index based on the selected value
            let columnIndex;
            switch (selectedValue) {
                case 'Total':
                    columnIndex = 3;
                    break;
                case 'gold':
                    columnIndex = 4;
                    break;
                case 'sliver':
                    columnIndex = 5;
                    break;
                case 'bronze':
                    columnIndex = 6;
                    break;
                case 'Num_Cyclists':
                    columnIndex = 7;
                    break;
                default:
                    columnIndex = 3;
            }

            // Perform your sorting logic based on the column index
            rows.sort((a, b) => {
                const aValue = parseInt(a.querySelector(`td:nth-child(${columnIndex})`).textContent);
                const bValue = parseInt(b.querySelector(`td:nth-child(${columnIndex})`).textContent);
                return bValue - aValue;
            });

            // Re-attach the sorted rows to the table and update the rank column
            let rank = 1;
            let prevValue = null;

            rows.forEach((row, index) => {
                table.appendChild(row);

                // Get the current value for comparison
                const currentValue = parseInt(row.querySelector(`td:nth-child(${columnIndex})`).textContent);

                // If the current value is different from the previous value, increment the rank
                if (prevValue !== null && prevValue !== currentValue) {
                    rank = index + 1;
                }

                // Update the rank column
                row.querySelector('td:first-child').textContent = rank;

                // Update the previous value for the next iteration
                prevValue = currentValue;
            });
        });
    </script>
    <script>
        let displaySelected = false;
        const chartElement = document.getElementById('myChart');

        document.getElementById('display').addEventListener('click', function () {
            var country1 = document.getElementById('country1').value;
            var country2 = document.getElementById('country2').value;

            if (country1 && country2) {
                displaySelected = !displaySelected;
                var tableRows = document.querySelectorAll('[data-country]');

                tableRows.forEach(function (row) {
                    var countryCode = row.getAttribute('data-country');
                    if (displaySelected) {
                        if (countryCode === country1 || countryCode === country2) {
                            row.style.display = ''; // Show the row                          
                        } else {
                            row.style.display = 'none'; // Hide the row                            
                        }
                    } else {
                        row.style.display = ''; // Show all rows
                    }
                });

                if (displaySelected) {
                    chartElement.style.display = 'block'; // Show the chart
                } else {
                    chartElement.style.display = 'block'; // Hide the chart
                }
            } else {
                alert('Please enter both Country 1 and Country 2 values.');
            }
        });
        </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof populationGDPData !== 'undefined') {
                const ctx = document.getElementById('myChart').getContext('2d');

                const labels = Object.keys(populationGDPData);
                const populationData = labels.map((label) => populationGDPData[label].population);
                const gdpData = labels.map((label) => populationGDPData[label].gdp);

                const myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Population',
                                data: populationData,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y-axis-population'
                            },
                            {
                                label: 'GDP',
                                data: gdpData,
                                type: 'line',
                                fill: false,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                yAxisID: 'y-axis-gdp'
                            },
                        ],
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                id: 'y-axis-population',
                                type: 'linear',
                                position: 'left',
                                ticks: {
                                    beginAtZero: true
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Population'
                                }
                            }, {
                                id: 'y-axis-gdp',
                                type: 'linear',
                                position: 'right',
                                ticks: {
                                    beginAtZero: true
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'GDP'
                                }
                            }]
                        },
                    },
                });
            }
        });
        </script>  
</body>

</html>